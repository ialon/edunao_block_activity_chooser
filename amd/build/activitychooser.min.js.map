{"version":3,"file":"activitychooser.min.js","sources":["../src/activitychooser.js"],"sourcesContent":["/**\n * A block used as for choosing modules in a course.\n *\n * @module     block_activity_chooser/activitychooser\n * @copyright  2025 Josemaria Bolanos <admin@mako.digital>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from 'core_course/local/activitychooser/repository';\nimport * as Templates from 'core/templates';\nimport Pending from 'core/pending';\n\n// Set up some JS module wide constants that can be added to in the future.\n\n// Tab config options.\nconst ALLACTIVITIESRESOURCES = 0;\nconst ACTIVITIESRESOURCES = 2;\nconst ALLACTIVITIESRESOURCESREC = 3;\nconst ONLYALLREC = 4;\nconst ACTIVITIESRESOURCESREC = 5;\n\n// Module types.\nconst ACTIVITY = 0;\nconst RESOURCE = 1;\n\nlet initialized = false;\n\n/**\n * Set up the activity chooser.\n *\n * @method init\n * @param {Number} courseId Course ID to use later on in fetchModules()\n * @param {Object} chooserConfig Any PHP config settings that we may need to reference\n */\nexport const init = async (courseId, chooserConfig) => {\n    const pendingPromise = new Pending();\n\n    // Ensure we only add our listeners once.\n    if (initialized) {\n        return;\n    }\n\n    const fetchModuleData = (() => {\n        let innerPromise = null;\n\n        return () => {\n            if (!innerPromise) {\n                innerPromise = new Promise((resolve) => {\n                    resolve(Repository.activityModules(courseId));\n                });\n            }\n\n            return innerPromise;\n        };\n    })();\n\n    // We want to show the modal instantly but loading whilst waiting for our data.\n    let bodyPromiseResolver;\n    const bodyPromise = new Promise(resolve => {\n        bodyPromiseResolver = resolve;\n    });\n\n    buildBlock(bodyPromise);\n\n    // Now we have a modal we should start fetching data.\n    // If an error occurs while fetching the data, display the error within the modal.\n    const data = await fetchModuleData().catch(async(e) => {\n        const errorTemplateData = {\n            'errormessage': e.message\n        };\n        bodyPromiseResolver(await Templates.render('core_course/local/activitychooser/error', errorTemplateData));\n    });\n\n    // Early return if there is no module data.\n    if (!data) {\n        return;\n    }\n\n    bodyPromiseResolver(await Templates.render(\n        'core_course/activitychooser',\n        templateDataBuilder(data.content_items, chooserConfig)\n    ));\n\n    initialized = true;\n\n    pendingPromise.resolve();\n};\n\n/**\n * Given an array of modules we want to figure out where & how to place them into our template object\n *\n * @method templateDataBuilder\n * @param {Array} data our modules to manipulate into a Templatable object\n * @param {Object} chooserConfig Any PHP config settings that we may need to reference\n * @return {Object} Our built object ready to render out\n */\nconst templateDataBuilder = (data, chooserConfig) => {\n    // Setup of various bits and pieces we need to mutate before throwing it to the wolves.\n    let activities = [];\n    let resources = [];\n    let showAll = true;\n    let showActivities = false;\n    let showResources = false;\n\n    // Tab mode can be the following [All, Resources & Activities, All & Activities & Resources].\n    const tabMode = parseInt(chooserConfig.tabmode);\n\n    // Filter the incoming data to find favourite & recommended modules.\n    const favourites = data.filter(mod => mod.favourite === true);\n    const recommended = data.filter(mod => mod.recommended === true);\n\n    // Whether the activities and resources tabs should be displayed or not.\n    const showActivitiesAndResources = (tabMode) => {\n        const acceptableModes = [\n            ALLACTIVITIESRESOURCES,\n            ALLACTIVITIESRESOURCESREC,\n            ACTIVITIESRESOURCES,\n            ACTIVITIESRESOURCESREC,\n        ];\n\n        return acceptableModes.indexOf(tabMode) !== -1;\n    };\n\n    // These modes need Activity & Resource tabs.\n    if (showActivitiesAndResources(tabMode)) {\n        // Filter the incoming data to find activities then resources.\n        activities = data.filter(mod => mod.archetype === ACTIVITY);\n        resources = data.filter(mod => mod.archetype === RESOURCE);\n        showActivities = true;\n        showResources = true;\n\n        // We want all of the previous information but no 'All' tab.\n        if (tabMode === ACTIVITIESRESOURCES || tabMode === ACTIVITIESRESOURCESREC) {\n            showAll = false;\n        }\n    }\n\n    const recommendedBeforeTabs = [\n        ALLACTIVITIESRESOURCESREC,\n        ONLYALLREC,\n        ACTIVITIESRESOURCESREC,\n    ];\n    // Whether the recommended tab should be displayed before the All/Activities/Resources tabs.\n    const recommendedBeginning = recommendedBeforeTabs.indexOf(tabMode) !== -1;\n\n    // Given the results of the above filters lets figure out what tab to set active.\n    // We have some favourites.\n    const favouritesFirst = !!favourites.length;\n    const recommendedFirst = favouritesFirst === false && recommendedBeginning === true && !!recommended.length;\n    // We are in tabMode 2 without any favourites.\n    const activitiesFirst = showAll === false && favouritesFirst === false && recommendedFirst === false;\n    // We have nothing fallback to show all modules.\n    const fallback = showAll === true && favouritesFirst === false && recommendedFirst === false;\n\n    return {\n        'default': data,\n        showAll: showAll,\n        activities: activities,\n        showActivities: showActivities,\n        activitiesFirst: activitiesFirst,\n        resources: resources,\n        showResources: showResources,\n        favourites: favourites,\n        recommended: recommended,\n        recommendedFirst: recommendedFirst,\n        recommendedBeginning: recommendedBeginning,\n        favouritesFirst: favouritesFirst,\n        fallback: fallback,\n    };\n};\n\n/**\n * Given an object we want to add the content to the block and display it.\n *\n * @method buildBlock\n * @param {Promise} bodyPromise\n * @return {Object} The modal ready to display immediately and render bodyPromise in later.\n */\nconst buildBlock = (bodyPromise) => {\n    const pendingBlockPromise = new Pending();\n\n    let block = document.querySelector('.block_activity_chooser');\n    if (block) {\n        // Now we can actually display the content.\n        bodyPromise.then((html, js) => {\n            // let templateContext = {\n            //     classes: 'modchooser'\n            // };\n\n            // const {html} = Templates.renderForPromise('core_course/activitychooser', templateContext);\n            let content = block.querySelector('#block-activity-chooser-content');\n            content.innerHTML = html;\n\n            if (js) {\n                Templates.runTemplateJS(js);\n            }\n        });\n    }\n\n    pendingBlockPromise.resolve();\n};\n"],"names":["e","_getRequireWildcardCache","WeakMap","r","t","_interopRequireWildcard","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","Repository","Templates","_pending","initialized","_exports","init","async","courseId","chooserConfig","pendingPromise","Pending","fetchModuleData","innerPromise","Promise","resolve","activityModules","bodyPromiseResolver","bodyPromise","buildBlock","data","catch","errorTemplateData","errormessage","message","render","templateDataBuilder","content_items","activities","resources","showAll","showActivities","showResources","tabMode","parseInt","tabmode","favourites","filter","mod","favourite","recommended","indexOf","showActivitiesAndResources","archetype","recommendedBeginning","favouritesFirst","length","recommendedFirst","activitiesFirst","fallback","pendingBlockPromise","block","document","querySelector","then","html","js","innerHTML","runTemplateJS"],"mappings":"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"}